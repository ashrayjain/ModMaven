{% extends "base.html" %}
{% block title %}{{ modName }}-{{modTitle}}{% endblock %}
{% block main_content %}
    <div class="row-fluid">
        <div class="span12 color-head">
            <h3>{{modName}}</h3>
            <div id="Tabs">
                <ul class="nav nav-pills">
                    <li class="active"><a href="#Info" data-toggle="pill">Information</a></li>
                    <li><a href="#Tree" data-toggle="pill" id="treebutton">Tree</a></li>
                    <li><a href="#Stats" data-toggle="pill">Statistics</a></li>
                    <li><a href="#Disc" data-toggle="pill">Discussion</a></li>
                </ul>
                <div class="pill-content">
                    <div id="Info" class="pill-pane active">
                        <h4>{{modTitle}}</h4>
                        <p class="lead">{{modDesc}}</p>
                    </div>
                    <div id="Tree" class="pill-pane">
                        <div class="TreeSpace row-fluid"></div>
                            <a href="#myModal" role="button" class="btn" data-toggle="modal">Launch demo modal</a>

                            <!-- Modal -->
                            <div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                <h3 id="myModalLabel">Modal header</h3>
                            </div>
                            <div class="modal-body">
                                <p>One fine body…</p>
                            </div>
                            <div class="modal-footer">
                                <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
                                <button class="btn btn-primary">Save changes</button>
                            </div>
                        </div>
                        <script type="text/javascript">

                            document.getElementById("treebutton").onclick = function() {
                                d3.selectAll("svg")
                                        .remove();
                                var canvas = d3.select('.TreeSpace')
                                        .append("svg")
                                        .attr("width", 1000)//document.getElementsByTagName('body')[0].clientWidth/1.5)
                                        .attr("height", 1500)
                                        .append("g")
                                        .attr("transform", "translate(50,50");

                                var borderRect = canvas.append("rect")
                                        .attr("width", 1000)//document.getElementsByTagName('body')[0].clientWidth/1.5)
                                        .attr("height",1500)
                                        .attr("stroke","black")
                                        .attr("stroke-width", 2.5)
                                        .attr("fill","grey")
                                        .attr("opacity", 0.65);

                                var tree = d3.layout.tree()
                                        .size([1000,750]);

                                d3.json("http://localhost:8080/data/test2.json", function (error,jsonData) {
                                    //var id="{{modName}}"
                                    //tree.children(function(d) { console.log(d[id].prereqs); return d[id].prereqs;})
                                    var nodes = tree.nodes(jsonData);
                                    var links = tree.links(nodes);

                                    var node = canvas.selectAll(".node")
                                            .data(nodes)
                                            .enter()
                                            .append("g")
                                            .attr("class","node")
                                            .attr("transform", function (d) { return "translate(" + d.x + "," + (d.y + 50) + ")"; })

                                    var diagonal = d3.svg.diagonal()
                                            .projection(function(d) { return [d.x, d.y+50]; });
                                    var x,y;
                                    canvas.selectAll(".link")
                                            .data(links)
                                            .enter()
                                            .append("path")
                                            .attr("class", "link")
                                            .attr("fill","none")
                                            .attr("stroke", "black")
                                            .attr("opacity", 0)
                                            .attr("d", diagonal);

                                    var backButton = canvas.append("circle")
                                                        .attr("r", 25)
                                                        .attr("cx", 50)
                                                        .attr("cy", 50)
                                                        .attr("fill", "steelblue")
                                                        .attr("stroke", "black")
                                                        .attr("stroke-width", 1.5);
                                                        
                                    backButton.append("text")
                                                .text(function(d){ return "Back";})
                                                .style("fill", "black")
                                                .attr("text-anchor", "middle")
                                                .attr("class", "lead");

                                    var rectangles = node.append("rect")
                                            .attr("width", 0)
                                            .attr("height", 0)
                                            .attr("x", -50)
                                            .attr("y", -35)
                                            .attr("rx", 20)
                                            .attr("ry", 20)
                                            .attr("stroke", "black")
                                            .attr("stroke-width", 1.5)
                                            .attr("opacity", 1)
                                            .attr("nodeValue", function(d) { return d.name;})
                                            .attr("fill", "steelblue");

                                    node.append("text")
                                            .text(function(d) { return d.name; })
                                            .style("fill", "none")
                                            .style("opacity", 0)
                                            .attr("text-anchor", "middle")
                                            .attr("text-decoration", "underline")
                                            .attr("class", "lead");

                                    node.selectAll("rect")
                                            .transition()
                                            .duration(2000)
                                            .attr("width", 100)
                                            .attr("height", 70)
                                            .ease("elastic");

                                    node.selectAll("text")
                                            .transition()
                                            .delay(2000)
                                            .duration(2000)
                                            .style("fill", "black")
                                            .style("opacity",1);

                                    canvas.selectAll("path")
                                            .transition()
                                            .delay(2000)
                                            .duration(1500)
                                            .attr("opacity",1);

                                    canvas.on("mouseover", function() {
                                        node.selectAll("rect")
                                                .transition()
                                                .attr("width", 100);
                                    })
                                    rectangles.on("click", function(d,i) {
                                        d3. select(this)
                                                .transition()
                                                .attr("width", 500);
                                        var currNode=this.parentNode;
                                        var currMod= d3.select(currNode).text();
                                        //console.log(currNode);
                                        d3.select(".modal-body")
                                            .select("p")
                                            .text(currMod);    
                                        $('#myModal').modal('show');
                                    })
                                    console.log(rectangles);
                                })
                            }
                        </script>
                    </div>
                    <div id="Stats" class="pill-pane">
                        <p>StatsTabContent</p>
                    </div>
                    <div id="Disc" class="pill-pane">
                        <p>DiscTabContent</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
